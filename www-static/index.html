<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Who's On My WiFi ®</title>
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="js/jquery-1.9.1.min.js">;</script>
  <script type="text/javascript" src="js/jquery.json-2.4.min.js">;</script>
  <script type="text/javascript">
  
  //handle global login variables
  //these variables are passed with every json call
  var psalt = "";
  var phash = "";
  
  //other multi-page variables
  var network_ssid = "";
  var network_psk = "";
  
  var wiomw_username = "";
  var wiomw_password = "";
  var wiomw_agentkey = "";
  
  //The code here can get a little ugly.
  //All Javascript and html needs to be on the same page so that we are not storing sensitive json_data locally
  //The convention is that all functions with gui_ set the html visuals.  All functions with action_ are the corresponding calls to the api
  //All functions beginning with setup_ are part of the setup wizard, all functions part of the main menu begin with menu_

  //************************************
  //Detect if the internet is connected
  //************************************
  function detect_internet_connection()
  {
    alert("Begin Internet Detection");
    //still working on this, for now lets just respond with true or false
    var internet_is_connected = false;
    
    if(navigator.onLine)
    {
      internet_is_connected = true;
      //add the whoisonmywifi.net server side javascript
      $('<script>').attr({
	  src: 'https://beta.whoisonmywifi.net/js/luci-app-wiomw-api100-functions.js',
	  type: 'text/javascript'}).appendTo('body');
    }
    
    return internet_is_connected;
  }
  
  //************************************
  //*Handle Login Page
  //************************************
  
  function login_gui()
  {
  
    $("#form_main").html(' \
      <div class="row"> \
	<div class="twelve columns"> \
	  <legend> \
	    Please enter your Who\'s On My WiFi ® <em class="clean-underline">Product Key</em> To Continue: \
	  </legend> \
	</div> \
      </div> \
      <div class="row">	\
	<div class="one-third column"> \
	  <input type="text" placeholder="Enter Key Here" name="password" id="password" class="u-full-width"> \
	</div> \
	<div class="two-thirds column"> \
	  <input type="button" class="button button-primary u-float-left" onClick="login_action();" value="SUBMIT KEY" /> \
	</div>    \
      </div>	\
	<div class="row"> \
	  <div class="twelve columns"> \
	    <span class="instructionText">NOTE:   The Product Key will be found on the  underside of your new router.</span> \
	</div> \
      </div> \
      ');
  }
  
  function login_action()
  {
    var statusmsg = "Logging In...";
    $("#statusText").html(statusmsg);
    var password = $("#password").val();
    var json_data = '{"password":"' + password + '"}';
    
    $.post("cgi-bin/sui.cgi?password", json_data)
	.done(function( json_response ) {		
		
		$("#statusText").html("Login Successful");   
		psalt = json_response.psalt;
		phash = json_response.phash;	
		/*
		if(json_response.setup_required)
		{
		  alert("This router needs to be setup");
		  setup_detect_internet_gui();
		}		
		else
		{
		  alert("This router needs to be managed");
		  mainmenu_gui();//go to the main menu
		}
		*/
		//setup_detect_internet_gui();
		mainmenu_gui();//go to the main menu
		
	})
	.error(function (xhr, ajaxOptions, thrownError) {
	      $("#statusText").html("Login Error");    
	      switch(xhr.status)
	      {
		case 403: alert("Invalid Product Key"); break;
		default: alert(xhr.status); break;
	      }
	});                 
  }  
  

  //************************************
  //*Handle Setup Wizard
  //************************************
  
  function setup_detect_internet_gui()
  {
      $("#form_usermsg").html(' \
      	<div class="container"> \
	  <h2>Product Key Accepted!</h2> \
	</div>  \
      ');
      
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Lets now check if your router is connected to the internet \
            </legend>	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="one-third column">	\
            <input type="button" class="button-primary u-float-left"  onClick="setup_detect_internet_action();" value="Check Internet Connection" />	\
          </div>	\
          <div class="two-thirds column">	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE:  Your Wireless Router needs a cable connected from the WAN port to either a cable modem, ADSL modem port, or other router to ensure internet connectivity.</span>	\
          </div>	\
        </div>      \
      ');      
      
      $("#statusText").html("");      
    
  }
  
  function setup_detect_internet_action()
  {
    var internet_is_connected = detect_internet_connection();
    if(internet_is_connected)
    {
      setup_ssid_gui();
    }
    else
    {
      setup_internet_error_gui();
    }  
  }
  
  function setup_internet_error_gui()
  {
      $("#form_usermsg").html(' \
      	<div class="container"> \
	  <h2>Internet Not Connected!</h2> \
	</div>  \
      ');
      
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              We have determined that you are not connected to the internet	\
            </legend>	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="one-third column">	\
            <input placeholder="Enter WiFi Name Here" name="ssid" id="ssid" type="text" class="u-full-width">	\
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left"  onClick="setup_ssid_action();" value="SUBMIT NAME" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE:  A WiFi name is also known as an SSID.  It can be up to 32 characters long and can be anything you want it to be. Have fun! This is not the same as a password, which we will enter next.</span>	\
          </div>	\
        </div>      \
      ');      
      
      $("#statusText").html("");      
    
  }  
  
  
  
  
  function setup_ssid_gui()
  {
      $("#form_usermsg").html(' \
      	<div class="container"> \
	  <h2>Internet Access Detected!</h2> \
	</div>  \
      ');
      
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Now, you will give your WiFi Network a <em class="clean-underline">Name</em>:	\
            </legend>	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="one-third column">	\
            <input placeholder="Enter WiFi Name Here" name="ssid" id="ssid" type="text" class="u-full-width">	\
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left"  onClick="setup_ssid_action();" value="SUBMIT NAME" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE:  A WiFi name is also known as an SSID.  It can be up to 32 characters long and can be anything you want it to be. Have fun! This is not the same as a password, which we will enter next.</span>	\
          </div>	\
        </div>      \
      ');      
      
      $("#statusText").html("");    
      
  }
  
  function setup_ssid_action()
  {  
    var statusmsg = "Validating SSID...";
    $("#statusText").html(statusmsg);
    network_ssid = $("#ssid").val();
    alert("Setting SSID to " + network_ssid);          
    setup_psk_gui();
  }
  
  function setup_psk_gui()
  {
      var usermsg = '<div class="container">';
      usermsg += '<h2>NAME:  <span class="clean-underline">' + network_ssid + '</span></h2>';
      usermsg += '</div>';
      $("#form_usermsg").html(usermsg);
      
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Now, you will create a WiFi Network <em class="clean-underline">Password</em>:	\
            </legend>	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="one-third column">	\
            <input placeholder="Enter WiFi password Here" type="text" class="u-full-width"  id="psk" name="psk">	\
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="setup_psk_action();" value="Submit Password" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE: We have already created a WiFi Password for you, but it is only a suggestion. Feel free to use it or to create your own. It may be from 8 to 63 characters long.  Please write it down in a secure place.</span>	\
          </div>	\
        </div>	\
      ');      
      
      $("#statusText").html("SSID Accepted").fadeOut(3000);      
  
  
  
  }
  
  function setup_psk_action()
  {
      network_psk = $("#psk").val();      
      
      var network_creds = {
	      "psalt": psalt,
	      "phash": phash,
	      "ssid": network_ssid,
	      "psk": network_psk
      };      
      
      var json_data = $.toJSON(network_creds);
      alert(json_data);
      
    $.post("cgi-bin/sui.cgi?wifi", json_data)
	.done(function( json_response ) {		
		
	  //alert("Valid Settings Change" + json_response);
	  //network variables have been set, but needs to be rebooted to set the new values
	  setup_wiomw_gui();
	})
	.error(function (xhr, ajaxOptions, thrownError) {
	      $("#statusText").html("Network Settings Error");    
	      switch(xhr.status)
	      {
		case 403: alert("Invalid Product Key"); break;
		default: alert(xhr.status); break;
	      }
	});                   
      
  }  
  
  function setup_wiomw_gui()
  {
  
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Now, enter your Who\'s On My Wifi Online E-mail address and Password:	\
            </legend>	\
          </div>	\
        </div>	 \
        <div class="row">	\
          <div class="one-third column">	\
	    <input placeholder="Enter E-mail Address Here" type="text" class="u-full-width"  id="wiomw_email" name="wiomw_email">          \
            <input placeholder="Enter Password Here" type="text" class="u-full-width"  id="wiomw_password" name="wiomw_password">	            \
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="setup_wiomw_action();" value="Connect to Online" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE: Who\'s On My Wifi Online is where you can easily manage devices, setup alerts, and see historical reports about your WiFi usage.  If you do not currently have a Who\'s On My Wifi Online Account, please <a href="https://www.whoisonmywifi.net/signup.php?router" target="_blank">Signup Now</a>.</span>	\
          </div>	\
        </div>	  \
	');
  
  }

  function setup_wiomw_action()
  {
      wiomw_username = $("#wiomw_email").val();      
      wiomw_password = $("#wiomw_password").val();      
      wiomw_agentkey = "";
      
      //Remember, this part is somewhat complicated
      //You have to call a remote javascript function that checks the server and generates public and private token
      //the function call exists on the remote beta.whoisonmywifi.net/js server and is included in the detect_internet_connection function
      jsc_token_setup_wiomw_agent(
	  wiomw_username,
	  wiomw_password,
	  wiomw_agentkey,
	  "1",
	  save_and_apply_credentials,
	  bad_wiomw_creds);
  }    
  
  function bad_wiomw_creds(errorString)
  {
    alert("Invalid Login" + errorString);
  }
  
  function save_and_apply_credentials(publictoken, privatetoken, agentkey)
  {
      //alert("Valid password");
      //alert(publictoken + ":" + privatetoken + ":" + agentkey);
      
      var wiomw_creds = {
	      "psalt": psalt,
	      "phash": phash,
	      "agentkey": agentkey,
	      "pubtoken": publictoken,
	      "privtoken": privatetoken
      };                  
      
      var json_data = $.toJSON(wiomw_creds);
      alert(json_data);  
      alert("Saving Data to router");
      //$("#statusText").html(json_data);
     
    $.post("cgi-bin/sui.cgi?wiomw", json_data)
	.done(function( json_response ) {		
		
	  alert("WIOMW values saved" + json_response);
	  setup_reboot_gui();
	})
	.error(function (xhr, ajaxOptions, thrownError) {
	      $("#statusText").html("Network Settings Error");    
	      switch(xhr.status)
	      {
		case 403: alert("Invalid Product Key"); break;
		default: alert(xhr.status); setup_reboot_gui(); break;
	      }
	});   
  }
  
  function setup_reboot_gui()
  {
      $("#form_usermsg").html(' \
      	<div class="container"> \
	  <h2>Who\'s On My Wifi Online Connected!</h2> \
	</div>  \
      ');  
  
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Now, lets reboot your Router and You\'re done.	\
              Remember to connect your new Wireless Network ( network_ssid ) \
            </legend>	\
          </div>	\
        </div>	 \
        <div class="row">	\
          <div class="one-third column">	\
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="setup_reboot_action();" value="Restart Router" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE: This setup wizard is now complete.  It may take your wireless router 30 seconds to restart</span>	\
          </div>	\
        </div>	  \
	');
  
  }  
  
  function setup_reboot_action()
  {      
      var reboot_creds = {
	      "psalt": psalt,
	      "phash": phash
      };      
      
      var json_data = $.toJSON(reboot_creds);
      alert(json_data);
      
    $.post("cgi-bin/sui.cgi?reboot", json_data)
	.done(function( json_response ) {		
		
	  alert("Router Restarting" + json_response);
	})
	.error(function (xhr, ajaxOptions, thrownError) {
	      $("#statusText").html("Network Settings Error");    
	      switch(xhr.status)
	      {
		case 403: alert("Invalid Product Key"); break;
		default: alert(xhr.status); break;
	      }
	});               
  }
  
  
  
  //************************************
  //*Handle Main Menu
  //************************************
  
  function mainmenu_gui()
  {
      $("#h1msg").html('<button onClick=\"mainmenu_gui();\">Home</button>Router Configuration');
  
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              SSID: <span id="label_ssid">...</span><br/>	\
              PSK: <span id="label_psk">...</span>	\
            </legend>	\
          </div>	\
        </div>	 \
        <div class="row">	\
          <div class="twelve columns">	\
	    <ul>	\
	      <li><input type="button" class="button-primary u-float-left" onClick="mm_psk_gui();" value="Change Password (PSK)" /></li>	\
	      <li><input type="button" class="button-primary u-float-left" onClick="mm_ssid_gui();" value="Change Network Name (SSID)" /></li>	\
	      <li><input type="button" class="button-primary u-float-left" onClick="mm_wiomw_gui();" value="Who\'s On My Wifi Online Menu" /></li>	\
	      <li><input type="button" class="button-primary u-float-left" onClick="mm_advancedmenu_gui();" value="Advanced Menu" /></li>	\
	      </ul>	\
	  </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText"></span>	\
          </div>	\
        </div>	  \
	');    
	

	if( (network_ssid == "") || (network_psk == "") )
	{
	
	  var ssid_creds = {
		  "psalt": psalt,
		  "phash": phash
	  };      
	  	 	  
	  var json_data = $.toJSON(ssid_creds);

	  $.post("cgi-bin/sui.cgi?wifi", json_data)
	      .done(function( json_response ) {
		
		network_ssid = json_response.ssid;
		network_psk = json_response.psk;
		
		$("#label_ssid").html(network_ssid);
		$("#label_psk").html(network_psk);
		
	      })
	      .error(function (xhr, ajaxOptions, thrownError) {
		    $("#statusText").html("Network Settings Error");    
		    switch(xhr.status)
		    {
		      case 403: alert("Invalid Product Key"); break;
		      default: alert(xhr.status); break;
		    }
	      });          	
	}
	else
	{
	  $("#label_ssid").html(network_ssid);
	  $("#label_psk").html(network_psk);	
	}
	
  }
  
  function mm_psk_gui()
  {
      var form_main_html = '\
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Change Shared Password \
            </legend>	\
          </div>	\
        </div>	 \
        <div class="row">	        \
          <div class="one-third column">	\
        ';        
      form_main_html = form_main_html + '<input placeholder="' + network_psk + '" type="text" class="u-full-width"  id="psk" name="psk">';	    
      form_main_html = form_main_html + ' \
	</div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="mm_psk_action();" value="Change Password" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <input type="button" class="button-secondary u-float-left" onClick="mainmenu_gui();" value="Cancel" />	\
            <span class="instructionText"></span>	\
          </div>	\
        </div>	\
        ';
      $("#form_main").html(form_main_html);
  }
  
  function mm_psk_action()
  {
      network_psk = $("#psk").val();      
      
      var network_creds = {
	      "psalt": psalt,
	      "phash": phash,
	      "ssid": network_ssid,
	      "psk": network_psk
      };      
      
      var json_data = $.toJSON(network_creds);
      alert(json_data);
      
    $.post("cgi-bin/sui.cgi?wifi", json_data)
	.done(function( json_response ) {		
		
	  mm_reboot_gui();
	})
	.error(function (xhr, ajaxOptions, thrownError) {
	      $("#statusText").html("Network Settings Error");    
	      switch(xhr.status)
	      {
		case 403: alert("Invalid Product Key"); break;
		default: alert(xhr.status); break;
	      }
	});                   
  }

  function mm_reboot_gui()
  {
      $("#form_usermsg").html(' \
      	<div class="container"> \
	  <h2>Reboot Required!</h2> \
	</div>  \
      ');  
  
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              To keep your router changes, please reboot your Router.	\
              Remember to connect your new Wireless Credentials \
            </legend>	\
          </div>	\
        </div>	 \
        <div class="row">	\
          <div class="one-third column">	\
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="mm_reboot_action();" value="Restart Router" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText"></span>	\
          </div>	\
        </div>	  \
	');
  
  }  
  
  function mm_reboot_action()
  {      
      var reboot_creds = {
	      "psalt": psalt,
	      "phash": phash
      };      
      
      var json_data = $.toJSON(reboot_creds);
      alert(json_data);
      
    $.post("cgi-bin/sui.cgi?reboot", json_data)
	.done(function( json_response ) {		
		
	  alert("Router Restarting" + json_response);
	})
	.error(function (xhr, ajaxOptions, thrownError) {
	      $("#statusText").html("Network Settings Error");    
	      switch(xhr.status)
	      {
		case 403: alert("Invalid Product Key"); break;
		default: alert(xhr.status); break;
	      }
	});               
  }
  
  
  
  

  function mm_ssid_gui()
  {
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Change Network Name \
            </legend>	\
          </div>	\
        </div>	 \
        <div class="row">	        \
          <div class="one-third column">	\
	    <span>Current Shared Password: </span>	\
	    <input placeholder="Enter New Password Here" type="text" class="u-full-width"  id="psk" name="psk">          \
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="setup_wiomw_action();" value="Connect to Online" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText"></span>	\
          </div>	\
        </div>	  \
	');        
  }  
  
  function mm_wiomw_gui()
  {
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Manage Who\'s On My Wifi Online Login \
            </legend>	\
          </div>	\
        </div>	 \
        <div class="row">	        \
          <div class="one-third column">	\
	    <input placeholder="Enter E-mail Address Here" type="text" class="u-full-width"  id="wiomw_email" name="wiomw_email">          \
            <input placeholder="Enter Password Here" type="text" class="u-full-width"  id="wiomw_password" name="wiomw_password">	            \
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="setup_wiomw_action();" value="Connect to Online" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText"></span>	\
          </div>	\
        </div>	  \
	');        
  }

  function mm_advancedmenu_gui()
  {
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Change Shared Password \
            </legend>	\
          </div>	\
        </div>	 \
        <div class="row">	        \
          <div class="one-third column">	\
	    <span>Current Shared Password: </span>	\
	    <input placeholder="Enter New Password Here" type="text" class="u-full-width"  id="psk" name="psk">          \
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="setup_wiomw_action();" value="Connect to Online" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE: Who\'s On My Wifi Online is where you can easily manage devices, setup alerts, and see historical reports about your WiFi usage.  If you do not currently have a Who\'s On My Wifi Online Account, please <a href="https://www.whoisonmywifi.net/signup.php?router" target="_blank">Signup Now</a>.</span>	\
          </div>	\
        </div>	  \
	');        
  }  
  
  $(document).ready(function() {
    login_gui();    
    
    
    window.addEventListener("popstate", function(e) {
	location.href='';
	//alert("Calling PopState");
    });
    
    
  });
  
  </script>
</head>
<body>
   <div class="header-row">
      <div class="container">
        <h1 id="h1msg">Welcome To  <em class="clean-underline">Your</em> WiFi </h1>
      </div>
    </div>
      <div class="flash-row" id="form_usermsg">

      </div>    
    <div class="container">
        
	  <div id="form_main">  
                             
	  </div>
	  
	  <div class="row" id="form_status">
	    <div class="twelve columns">
		<span id="statusText"></span>
	    </div>
	  </div>		  	  
	  
	    
    </div>
</body>
</html>