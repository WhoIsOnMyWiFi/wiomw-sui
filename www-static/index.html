<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Who's On My WiFi™</title>
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="js/jquery-1.9.1.min.js">;</script>
  <script type="text/javascript" src="js/jquery.json-2.4.min.js">;</script>
  <script type="text/javascript" src="js/luci-app-wiomw-functions.js">;</script>		
  <script type="text/javascript">
  
  //handle global login variables
  //these variables are passed with every json call
  var psalt = "";
  var phash = "";
  
  //other multi-page variables
  var network_ssid = "";
  var network_psk = "";
  
  //The code here can get a little ugly.
  //All Javascript and html needs to be on the same page so that we are not storing sensitive json_data locally
  //The convention is that all functions with gui_ set the html visuals.  All functions with action_ are the corresponding calls to the api
   

  function login_gui()
  {
  
    $("#form_main").html(' \
      <div class="row"> \
	<div class="twelve columns"> \
	  <legend> \
	    Please enter your Who\'s On My WiFi™ <em class="clean-underline">Product Key</em> To Continue: \
	  </legend> \
	</div> \
      </div> \
      <div class="row">	\
	<div class="one-third column"> \
	  <input type="text" placeholder="Enter Key Here" name="password" id="password" class="u-full-width"> \
	</div> \
	<div class="two-thirds column"> \
	  <input type="button" class="button button-primary u-float-left" onClick="login_action();" value="SUBMIT KEY" /> \
	</div>    \
      </div>	\
	<div class="row"> \
	  <div class="twelve columns"> \
	    <span class="instructionText">NOTE:   The Product Key will be found on the  underside of your new router.</span> \
	</div> \
      </div> \
      ');
  }
  
  function login_action()
  {
    var statusmsg = "Logging In...";
    $("#statusText").html(statusmsg);
    var password = $("#password").val();
    var json_data = '{"password":"' + password + '"}';
    
    $.post("cgi-bin/sui.cgi?password", json_data)
	.done(function( json_response ) {		
		
		$("#statusText").html("Login Successful");   
		psalt = json_response.psalt;
		phash = json_response.phash;	
		//if(json_response.setup_required)
		//{
		  alert("This router needs to be setup");
		  setup_ssid_gui();//go to the setup wizard ssid page
		//}
		/*
		else
		{
		  alert("This router needs to be managed");
		  mainmenu_gui();//go to the main menu
		}
		*/
		
	})
	.error(function (xhr, ajaxOptions, thrownError) {
	      $("#statusText").html("Login Error");    
	      switch(xhr.status)
	      {
		case 403: alert("Invalid Product Key"); break;
		default: alert(xhr.status); break;
	      }
	});                 
  }  
  
  
  function setup_ssid_gui()
  {
      $("#form_usermsg").html(' \
      	<div class="container"> \
	  <h2>Product Key Accepted!</h2> \
	</div>  \
      ');
      
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Now, you will give your WiFi Network a <em class="clean-underline">Name</em>:	\
            </legend>	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="one-third column">	\
            <input placeholder="Enter WiFi Name Here" name="ssid" id="ssid" type="text" class="u-full-width">	\
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left"  onClick="setup_ssid_action();" value="SUBMIT NAME" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE:  A WiFi name is also known as an SSID.  It can be up to 32 characters long and can be anything you want it to be. Have fun! This is not the same as a password, which we will enter next.</span>	\
          </div>	\
        </div>      \
      ');      
      
      $("#statusText").html("");    
      
  }
  
  function setup_ssid_action()
  {  
    var statusmsg = "Validating SSID...";
    $("#statusText").html(statusmsg);
    network_ssid = $("#ssid").val();
    alert("Setting SSID to " + network_ssid);          
    setup_psk_gui();
  }
  
  function setup_psk_gui()
  {
      var usermsg = '<div class="container">';
      usermsg += '<h2>NAME:  <span class="clean-underline">' + network_ssid + '</span></h2>';
      usermsg += '</div>';
      $("#form_usermsg").html(usermsg);
      
      $("#form_main").html(' \
        <div class="row">	\
          <div class="twelve columns">	\
            <legend>	\
              Now, you will create a WiFi Network <em class="clean-underline">Password</em>:	\
            </legend>	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="one-third column">	\
            <input placeholder="Enter WiFi password Here" type="text" class="u-full-width"  id="psk" name="psk">	\
          </div>	\
          <div class="two-thirds column">	\
            <input type="button" class="button-primary u-float-left" onClick="setup_psk_action();" value="Submit Password" />	\
          </div>	\
        </div>	\
        <div class="row">	\
          <div class="twelve columns">	\
            <span class="instructionText">NOTE: We have already created a WiFi Password for you, but it is only a suggestion. Feel free to use it or to create your own. It may be from 8 to 63 characters long.  Please write it down in a secure place.</span>	\
          </div>	\
        </div>	\
      ');      
      
      $("#statusText").html("SSID Accepted").fadeOut(3000);      
  
  
  
  }
  
  function setup_psk_action()
  {
      network_psk = $("#psk").val();      
      
      var network_creds = {
	      "psalt": psalt,
	      "phash": phash,
	      "ssid": network_ssid,
	      "psk": network_psk
      };      
      
      var json_data = $.toJSON(network_creds);
      alert(json_data);
      
    $.post("cgi-bin/sui.cgi?wifi", json_data)
	.done(function( json_response ) {		
		
	  alert("Valid Settings Change" + json_response);
	})
	.error(function (xhr, ajaxOptions, thrownError) {
	      $("#statusText").html("Network Settings Error");    
	      switch(xhr.status)
	      {
		case 403: alert("Invalid Product Key"); break;
		default: alert(xhr.status); break;
	      }
	});                   
      
  }  
  
  $(document).ready(function() {
    login_gui();
  });
  
  </script>
</head>
<body>
   <div class="header-row">
      <div class="container">
        <h1>Welcome To  <em class="clean-underline">Your</em> WiFi </h1>
      </div>
    </div>
      <div class="flash-row" id="form_usermsg">

      </div>    
    <div class="container">
        
	  <form action="#" id="form_main">
  
            
	  </form>
	  
	  <div class="row" id="form_status">
	    <div class="twelve columns">
		<span id="statusText"></span>
	    </div>
	  </div>		  	  
	  
	    
    </div>
</body>
</html>